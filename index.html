<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Navglid</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,sans-serif;}
#map{height:100%;width:100%;}
#status{position:absolute;top:10px;left:50%;transform:translateX(-50%);
 background:rgba(0,0,0,.75);color:#fff;padding:8px 14px;border-radius:12px;font-size:14px;z-index:1000;}
#speed{position:absolute;top:70px;right:12px;background:rgba(0,0,0,.75);color:#0f0;
 padding:8px 12px;border-radius:12px;font-weight:bold;z-index:1000;}
#toolbar{position:absolute;bottom:0;left:0;right:0;background:rgba(20,20,20,.95);
 color:#fff;padding:10px;border-radius:18px 18px 0 0;z-index:1000;}
#toolbar button,#toolbar select{margin:4px;padding:8px 12px;border-radius:10px;border:none;}
#toolbar button{background:#1e88e5;color:#fff;}
#toolbar select{background:#333;color:#fff;}
</style>
</head>

<body>
<div id="map"></div>
<div id="status">Detecting GPS…</div>
<div id="speed">Speed: 0 km/h</div>

<div id="toolbar">
<select id="mapStyle">
<option value="street">Street</option>
<option value="satellite">Satellite</option>
<option value="terrain">Terrain</option>
<option value="dark">Dark</option>
</select>
<button onclick="enableMeasure()">Add Marker</button>
<button onclick="clearMeasure()">Clear</button>
<button onclick="toggleFollow()">Follow</button>
</div>

<script>
/* -------- MAP INIT -------- */
const map=L.map('map',{tap:false,maxZoom:19,minZoom:2}).setView([20,0],3);

const layers={
 street:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
 satellite:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
 terrain:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'),
 dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
};
layers.street.addTo(map);

/* MAP STYLE SWITCH */
document.getElementById('mapStyle').onchange=e=>{
 Object.values(layers).forEach(l=>map.removeLayer(l));
 layers[e.target.value].addTo(map);
};

/* -------- VARIABLES -------- */
let followMode=true;
let measuring=false;
let dragging=false;
let firstFix=true;
let lastPos=null;
let userMarker=null,accuracyCircle=null;
let markers=[],line,popup;
const statusBox=document.getElementById('status');
const speedBox=document.getElementById('speed');

/* -------- GPS -------- */
function onLocationFound(pos){
 const lat=pos.coords.latitude;
 const lng=pos.coords.longitude;
 const acc=pos.coords.accuracy;
 const spd=pos.coords.speed;

 lastPos=[lat,lng];
 statusBox.textContent=`GPS Active • Accuracy ${Math.round(acc)} m`;
 speedBox.textContent=`Speed: ${spd?Math.round(spd*3.6):0} km/h`;

 if(!userMarker){
  userMarker=L.circleMarker([lat,lng],{radius:8,color:'#fff',fillColor:'#1e88e5',fillOpacity:1}).addTo(map);
  accuracyCircle=L.circle([lat,lng],{radius:acc,color:'#1e88e5',fillOpacity:0.15}).addTo(map);
  map.setView([lat,lng],16);
 }else{
  userMarker.setLatLng([lat,lng]);
  accuracyCircle.setLatLng([lat,lng]).setRadius(acc);
 }

 if(followMode && !measuring && !dragging){
  map.panTo([lat,lng],{animate:true});
 }
}

function onLocationError(err){
 if(err.code===1) statusBox.textContent='Location permission denied';
 else if(err.code===2) statusBox.textContent='GPS unavailable';
 else if(err.code===3) statusBox.textContent='GPS timeout';
 else statusBox.textContent='GPS error';
}

if('geolocation' in navigator){
 navigator.geolocation.watchPosition(onLocationFound,onLocationError,{enableHighAccuracy:true,maximumAge:1000,timeout:15000});
}else statusBox.textContent='Geolocation not supported';

/* -------- FOLLOW TOGGLE -------- */
function toggleFollow(){ followMode=!followMode; }

/* -------- MEASURE MARKERS -------- */
function enableMeasure(){ measuring=true; followMode=false; alert("Tap map to place markers"); }
function clearMeasure(){
 markers.forEach(m=>map.removeLayer(m));
 markers=[]; if(line) map.removeLayer(line); line=null;
 if(popup) map.closePopup(popup); popup=null;
 measuring=false;
}

map.on('click',e=>{
 if(!measuring) return;
 if(markers.length===2) clearMeasure();
 const m=L.marker(e.latlng,{draggable:true}).addTo(map);
 m.on('dragstart',()=>{ dragging=true; followMode=false; });
 m.on('drag',updateDistance);
 m.on('dragend',()=>{ dragging=false; updateDistance(); });
 markers.push(m);
 if(markers.length===2){
  line=L.polyline([], {color:'red',weight:3}).addTo(map);
  updateDistance();
 }
});

/* -------- LIVE DISTANCE -------- */
function updateDistance(){
 if(markers.length<2) return;
 const p1=markers[0].getLatLng();
 const p2=markers[1].getLatLng();
 line.setLatLngs([p1,p2]);
 const m=map.distance(p1,p2);
 const km=(m/1000).toFixed(2);
 const mi=(km*0.621371).toFixed(2);
 const center=L.latLngBounds([p1,p2]).getCenter();
 if(!popup){
  popup=L.popup({closeButton:false}).setLatLng(center)
   .setContent(`<b>Distance</b><br>${km} km<br>${mi} miles`).openOn(map);
 }else{
  popup.setLatLng(center)
   .setContent(`<b>Distance</b><br>${km} km<br>${mi} miles`);
 }
}

/* -------- MAP INTERACTION -------- */
map.on('mousedown touchstart',()=>{});
map.on('mouseup touchend',()=>{});
map.on('zoomstart',()=>{});
map.on('zoomend',()=>{});
</script>
</body>
</html>
